/* src/gui/font.c - Implémentation du système de rendu de texte */

#include "font.h"
#include "render.h"
#include "../mm/kheap.h"
#include "../include/string.h"

/* Police Roboto externe */
extern const font_t* font_roboto;

/* Police VGA 8x16 intégrée - caractères ASCII 32-126 */
static const uint8_t vga_font_8x16[] = {
    /* Espace (32) */ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* ! */ 0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    /* " */ 0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* # */ 0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,
    /* $ */ 0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00,
    /* % */ 0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00,
    /* & */ 0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    /* ' */ 0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* ( */ 0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,
    /* ) */ 0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,
    /* * */ 0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,
    /* + */ 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
    /* , */ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00,
    /* - */ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* . */ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    /* / */ 0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,
    /* 0 */ 0x00,0x00,0x3C,0x66,0xC3,0xC3,0xDB,0xDB,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00,
    /* 1 */ 0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00,
    /* 2 */ 0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00,
    /* 3 */ 0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* 4 */ 0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00,
    /* 5 */ 0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* 6 */ 0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* 7 */ 0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,
    /* 8 */ 0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* 9 */ 0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00,
    /* : */ 0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
    /* ; */ 0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,
    /* < */ 0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00,
    /* = */ 0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* > */ 0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00,
    /* ? */ 0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
    /* @ */ 0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00,
    /* A */ 0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    /* B */ 0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00,
    /* C */ 0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00,
    /* D */ 0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00,
    /* E */ 0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,
    /* F */ 0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    /* G */ 0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00,
    /* H */ 0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    /* I */ 0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    /* J */ 0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00,
    /* K */ 0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    /* L */ 0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00,
    /* M */ 0x00,0x00,0xC3,0xE7,0xFF,0xFF,0xDB,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00,
    /* N */ 0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00,
    /* O */ 0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* P */ 0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    /* Q */ 0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00,
    /* R */ 0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    /* S */ 0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* T */ 0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    /* U */ 0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* V */ 0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x00,0x00,0x00,0x00,
    /* W */ 0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xDB,0xDB,0xFF,0x66,0x66,0x00,0x00,0x00,0x00,
    /* X */ 0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x3C,0x66,0xC3,0xC3,0x00,0x00,0x00,0x00,
    /* Y */ 0x00,0x00,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    /* Z */ 0x00,0x00,0xFF,0xC3,0x86,0x0C,0x18,0x30,0x60,0xC1,0xC3,0xFF,0x00,0x00,0x00,0x00,
    /* [ */ 0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00,
    /* \ */ 0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00,
    /* ] */ 0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00,
    /* ^ */ 0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* _ */ 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
    /* ` */ 0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    /* a */ 0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    /* b */ 0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,
    /* c */ 0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* d */ 0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    /* e */ 0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* f */ 0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    /* g */ 0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00,
    /* h */ 0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00,
    /* i */ 0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    /* j */ 0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00,
    /* k */ 0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00,
    /* l */ 0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,
    /* m */ 0x00,0x00,0x00,0x00,0x00,0xE6,0xFF,0xDB,0xDB,0xDB,0xDB,0xDB,0x00,0x00,0x00,0x00,
    /* n */ 0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,
    /* o */ 0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* p */ 0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,
    /* q */ 0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00,
    /* r */ 0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00,
    /* s */ 0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00,
    /* t */ 0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00,
    /* u */ 0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00,
    /* v */ 0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x00,0x00,0x00,0x00,
    /* w */ 0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xDB,0xDB,0xFF,0x66,0x00,0x00,0x00,0x00,
    /* x */ 0x00,0x00,0x00,0x00,0x00,0xC3,0x66,0x3C,0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00,
    /* y */ 0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00,
    /* z */ 0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00,
    /* { */ 0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00,
    /* | */ 0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
    /* } */ 0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00,
    /* ~ */ 0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

static font_t g_font_vga = {
    .glyphs = vga_font_8x16,
    .glyph_width = 8,
    .glyph_height = 16,
    .bytes_per_glyph = 16,
    .first_char = 32,
    .num_chars = 95,
    .style = FONT_STYLE_REGULAR,
    .name = "VGA"
};

/* Police système par défaut - initialisée à VGA, puis Roboto dans font_init() */
const font_t* font_system = &g_font_vga;
const font_t* font_vga = &g_font_vga;
const font_t* font_small = NULL;
const font_t* font_large = NULL;

int font_init(void) {
    /* Utiliser Roboto comme police système par défaut */
    if (font_roboto) {
        font_system = font_roboto;
    }
    return 0;
}

void draw_char(char c, point_t pos, const font_t* font, uint32_t color) {
    if (!font) font = font_system;
    uint8_t ch = (uint8_t)c;
    if (ch < font->first_char || ch >= font->first_char + font->num_chars) return;
    
    uint32_t idx = ch - font->first_char;
    const uint8_t* glyph = font->glyphs + idx * font->bytes_per_glyph;
    
    for (uint32_t y = 0; y < font->glyph_height; y++) {
        uint8_t row = glyph[y];
        for (uint32_t x = 0; x < font->glyph_width; x++) {
            if (row & (0x80 >> x)) {
                draw_pixel(pos.x + (int32_t)x, pos.y + (int32_t)y, color);
            }
        }
    }
}

void draw_char_alpha(char c, point_t pos, const font_t* font, rgba_t color) {
    if (!font) font = font_system;
    uint8_t ch = (uint8_t)c;
    if (ch < font->first_char || ch >= font->first_char + font->num_chars) return;
    
    uint32_t idx = ch - font->first_char;
    const uint8_t* glyph = font->glyphs + idx * font->bytes_per_glyph;
    
    for (uint32_t y = 0; y < font->glyph_height; y++) {
        uint8_t row = glyph[y];
        for (uint32_t x = 0; x < font->glyph_width; x++) {
            if (row & (0x80 >> x)) {
                draw_pixel_alpha(pos.x + (int32_t)x, pos.y + (int32_t)y, color);
            }
        }
    }
}

void draw_text(const char* text, point_t pos, const font_t* font, uint32_t color) {
    if (!text) return;
    if (!font) font = font_system;
    int32_t x = pos.x, y = pos.y;
    
    while (*text) {
        if (*text == '\n') { x = pos.x; y += (int32_t)font->glyph_height; }
        else if (*text == '\t') { x += (int32_t)(font->glyph_width * 4); }
        else { draw_char(*text, point_make(x, y), font, color); x += (int32_t)font->glyph_width; }
        text++;
    }
}

void draw_text_alpha(const char* text, point_t pos, const font_t* font, rgba_t color) {
    if (!text) return;
    if (!font) font = font_system;
    int32_t x = pos.x, y = pos.y;
    
    while (*text) {
        if (*text == '\n') { x = pos.x; y += (int32_t)font->glyph_height; }
        else if (*text == '\t') { x += (int32_t)(font->glyph_width * 4); }
        else { draw_char_alpha(*text, point_make(x, y), font, color); x += (int32_t)font->glyph_width; }
        text++;
    }
}

void draw_text_ex(const char* text, rect_t bounds, const font_t* font, rgba_t color, text_options_t opts) {
    if (!text || !font) return;
    text_bounds_t sz = measure_text(text, font);
    int32_t x = bounds.x, y = bounds.y;
    
    if (opts.align == TEXT_ALIGN_CENTER) x += ((int32_t)bounds.width - (int32_t)sz.width) / 2;
    else if (opts.align == TEXT_ALIGN_RIGHT) x += (int32_t)bounds.width - (int32_t)sz.width;
    if (opts.valign == TEXT_VALIGN_MIDDLE) y += ((int32_t)bounds.height - (int32_t)sz.height) / 2;
    else if (opts.valign == TEXT_VALIGN_BOTTOM) y += (int32_t)bounds.height - (int32_t)sz.height;
    
    draw_text_alpha(text, point_make(x, y), font, color);
}

void draw_text_aa(const char* text, point_t pos, const font_t* font, rgba_t color) {
    draw_text_alpha(text, pos, font, color);
}

text_bounds_t measure_text(const char* text, const font_t* font) {
    text_bounds_t b = {0, 0, 0};
    if (!text) return b;
    if (!font) font = font_system;
    
    uint32_t x = 0, max_x = 0, lines = 1;
    while (*text) {
        if (*text == '\n') { if (x > max_x) max_x = x; x = 0; lines++; }
        else if (*text == '\t') x += font->glyph_width * 4;
        else x += font->glyph_width;
        text++;
    }
    if (x > max_x) max_x = x;
    b.width = max_x; b.height = lines * font->glyph_height; b.baseline = font->glyph_height;
    return b;
}

text_bounds_t measure_text_ex(const char* text, const font_t* font, text_options_t opts) {
    (void)opts;
    return measure_text(text, font);
}

uint32_t char_width(char c, const font_t* font) {
    (void)c;
    return font ? font->glyph_width : 8;
}

uint32_t text_fit_width(const char* text, const font_t* font, uint32_t max_w) {
    if (!text || !font) return 0;
    uint32_t w = 0, count = 0;
    while (*text && w + font->glyph_width <= max_w) {
        w += font->glyph_width; count++; text++;
    }
    return count;
}

text_options_t text_options_default(void) {
    text_options_t o = {TEXT_ALIGN_LEFT, TEXT_VALIGN_TOP, false, 0, 0, 0, false};
    return o;
}

text_options_t text_options_centered(void) {
    text_options_t o = {TEXT_ALIGN_CENTER, TEXT_VALIGN_MIDDLE, false, 0, 0, 0, false};
    return o;
}

text_options_t text_options_right(void) {
    text_options_t o = {TEXT_ALIGN_RIGHT, TEXT_VALIGN_TOP, false, 0, 0, 0, false};
    return o;
}

font_t* font_load_psf(const uint8_t* data, size_t size) {
    (void)data; (void)size;
    return NULL; /* TODO */
}

font_t* font_create_bitmap(const uint8_t* glyphs, uint32_t w, uint32_t h, uint32_t first, uint32_t num) {
    font_t* f = (font_t*)kmalloc(sizeof(font_t));
    if (!f) return NULL;
    f->glyphs = glyphs; f->glyph_width = w; f->glyph_height = h;
    f->bytes_per_glyph = ((w + 7) / 8) * h; f->first_char = first; f->num_chars = num;
    f->style = FONT_STYLE_REGULAR; f->name = "Custom";
    return f;
}

void font_free(font_t* font) {
    if (font && font != &g_font_vga) kfree((void*)font);
}
