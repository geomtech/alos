/* src/kernel/fb_console.c - Framebuffer Console Implementation */
#include "fb_console.h"
#include "klog.h"
#include "../arch/x86_64/io.h"

/* VGA 8x16 font (partial - ASCII 32-126) */
static const uint8_t vga_font[95][16] = {
    /* Space (32) */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* ! */
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* " */
    {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* # */
    {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    /* $ */
    {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
    /* % */
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    /* & */
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* ' */
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* ( */
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    /* ) */
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    /* * */
    {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    /* + */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    /* , */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    /* - */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* . */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* / */
    {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    /* 0 */
    {0x00,0x00,0x3C,0x66,0xC3,0xC3,0xDB,0xDB,0xC3,0xC3,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* 1 */
    {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    /* 2 */
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 3 */
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 4 */
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* 5 */
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 6 */
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 7 */
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    /* 8 */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 9 */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    /* : */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* ; */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    /* < */
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    /* = */
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* > */
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    /* ? */
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* @ */
    {0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00},
    /* A */
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* B */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    /* C */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* D */
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    /* E */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* F */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* G */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    /* H */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* I */
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* J */
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    /* K */
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* L */
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* M */
    {0x00,0x00,0xC3,0xE7,0xFF,0xFF,0xDB,0xC3,0xC3,0xC3,0xC3,0xC3,0x00,0x00,0x00,0x00},
    /* N */
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* O */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* P */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* Q */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    /* R */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* S */
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* T */
    {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* U */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* V */
    {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x00,0x00,0x00,0x00},
    /* W */
    {0x00,0x00,0xC3,0xC3,0xC3,0xC3,0xC3,0xDB,0xDB,0xFF,0x66,0x66,0x00,0x00,0x00,0x00},
    /* X */
    {0x00,0x00,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x3C,0x66,0xC3,0xC3,0x00,0x00,0x00,0x00},
    /* Y */
    {0x00,0x00,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* Z */
    {0x00,0x00,0xFF,0xC3,0x86,0x0C,0x18,0x30,0x60,0xC1,0xC3,0xFF,0x00,0x00,0x00,0x00},
    /* [ */
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* \ */
    {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    /* ] */
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* ^ */
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* _ */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    /* ` */
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* a */
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* b */
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    /* c */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* d */
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* e */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* f */
    {0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* g */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00},
    /* h */
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* i */
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* j */
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    /* k */
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* l */
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* m */
    {0x00,0x00,0x00,0x00,0x00,0xE6,0xFF,0xDB,0xDB,0xDB,0xDB,0xDB,0x00,0x00,0x00,0x00},
    /* n */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    /* o */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* p */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    /* q */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00},
    /* r */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* s */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* t */
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    /* u */
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* v */
    {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x00,0x00,0x00,0x00},
    /* w */
    {0x00,0x00,0x00,0x00,0x00,0xC3,0xC3,0xC3,0xDB,0xDB,0xFF,0x66,0x00,0x00,0x00,0x00},
    /* x */
    {0x00,0x00,0x00,0x00,0x00,0xC3,0x66,0x3C,0x18,0x3C,0x66,0xC3,0x00,0x00,0x00,0x00},
    /* y */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00},
    /* z */
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* { */
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    /* | */
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    /* } */
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    /* ~ */
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

/* VGA to framebuffer color mapping */
uint32_t vga_to_fb_color[16] = {
    FB_COLOR_BLACK,         /* 0 */
    FB_COLOR_BLUE,          /* 1 */
    FB_COLOR_GREEN,         /* 2 */
    FB_COLOR_CYAN,          /* 3 */
    FB_COLOR_RED,           /* 4 */
    FB_COLOR_MAGENTA,       /* 5 */
    FB_COLOR_BROWN,         /* 6 */
    FB_COLOR_LIGHT_GRAY,    /* 7 */
    FB_COLOR_DARK_GRAY,     /* 8 */
    FB_COLOR_LIGHT_BLUE,    /* 9 */
    FB_COLOR_LIGHT_GREEN,   /* 10 */
    FB_COLOR_LIGHT_CYAN,    /* 11 */
    FB_COLOR_LIGHT_RED,     /* 12 */
    FB_COLOR_LIGHT_MAGENTA, /* 13 */
    FB_COLOR_YELLOW,        /* 14 */
    FB_COLOR_WHITE          /* 15 */
};

/* Framebuffer state */
static struct limine_framebuffer *g_fb = NULL;
static uint32_t *g_fb_addr = NULL;
static uint32_t g_fb_width = 0;
static uint32_t g_fb_height = 0;
static uint32_t g_fb_pitch = 0;  /* bytes per line */
static uint32_t g_fb_bpp = 0;

/* Console state */
static int g_cursor_col = 0;
static int g_cursor_row = 0;
static int g_view_start = 0;
static uint32_t g_fg_color = FB_COLOR_WHITE;
static uint32_t g_bg_color = FB_COLOR_BLACK;
static bool g_initialized = false;

/* Console buffer (character + colors) */
typedef struct {
    char c;
    uint32_t fg;
    uint32_t bg;
} fb_char_t;

static fb_char_t g_buffer[FB_CONSOLE_BUFFER_LINES][FB_CONSOLE_COLS];

/* ============================================ */
/* Internal functions                           */
/* ============================================ */

static inline void fb_put_pixel(uint32_t x, uint32_t y, uint32_t color) {
    if (x < g_fb_width && y < g_fb_height) {
        g_fb_addr[y * (g_fb_pitch / 4) + x] = color;
    }
}

static void fb_draw_char(int col, int row, char c, uint32_t fg, uint32_t bg) {
    if (col < 0 || col >= FB_CONSOLE_COLS || row < 0 || row >= FB_CONSOLE_ROWS) {
        return;
    }
    
    uint32_t x_start = col * FONT_WIDTH;
    uint32_t y_start = row * FONT_HEIGHT;
    
    /* Get font data */
    const uint8_t *glyph;
    if (c >= 32 && c <= 126) {
        glyph = vga_font[c - 32];
    } else {
        glyph = vga_font[0];  /* Space for unknown chars */
    }
    
    /* Draw the character */
    for (int y = 0; y < FONT_HEIGHT; y++) {
        uint8_t row_data = glyph[y];
        for (int x = 0; x < FONT_WIDTH; x++) {
            uint32_t color = (row_data & (0x80 >> x)) ? fg : bg;
            fb_put_pixel(x_start + x, y_start + y, color);
        }
    }
}

static void fb_scroll_buffer(void) {
    /* Move all lines up by one */
    for (int row = 0; row < FB_CONSOLE_BUFFER_LINES - 1; row++) {
        for (int col = 0; col < FB_CONSOLE_COLS; col++) {
            g_buffer[row][col] = g_buffer[row + 1][col];
        }
    }
    
    /* Clear the last line */
    for (int col = 0; col < FB_CONSOLE_COLS; col++) {
        g_buffer[FB_CONSOLE_BUFFER_LINES - 1][col].c = ' ';
        g_buffer[FB_CONSOLE_BUFFER_LINES - 1][col].fg = g_fg_color;
        g_buffer[FB_CONSOLE_BUFFER_LINES - 1][col].bg = g_bg_color;
    }
}

/* ============================================ */
/* Public functions                             */
/* ============================================ */

/* Serial output for early debug */
static void serial_char(char c) {
    while (!(inb(0x3F8 + 5) & 0x20));
    outb(0x3F8, c);
}
static void serial_str(const char *s) {
    while (*s) serial_char(*s++);
}
static void serial_hex(uint64_t v) {
    const char *hex = "0123456789ABCDEF";
    serial_str("0x");
    for (int i = 15; i >= 0; i--) {
        serial_char(hex[(v >> (i * 4)) & 0xF]);
    }
}

int fb_console_init(struct limine_framebuffer *fb) {
    serial_str("[FB] fb_console_init called\n");
    
    if (fb == NULL) {
        serial_str("[FB] ERROR: fb is NULL\n");
        return -1;
    }
    
    g_fb = fb;
    g_fb_addr = (uint32_t *)fb->address;
    g_fb_width = fb->width;
    g_fb_height = fb->height;
    g_fb_pitch = fb->pitch;
    g_fb_bpp = fb->bpp;
    
    serial_str("[FB] Address: ");
    serial_hex((uint64_t)fb->address);
    serial_str("\n[FB] Size: ");
    serial_hex(fb->width);
    serial_str("x");
    serial_hex(fb->height);
    serial_str(" bpp=");
    serial_hex(fb->bpp);
    serial_str("\n");
    
    /* Only support 32-bit color */
    if (g_fb_bpp != 32) {
        serial_str("[FB] ERROR: bpp != 32\n");
        return -1;
    }
    
    /* Initialize buffer */
    for (int row = 0; row < FB_CONSOLE_BUFFER_LINES; row++) {
        for (int col = 0; col < FB_CONSOLE_COLS; col++) {
            g_buffer[row][col].c = ' ';
            g_buffer[row][col].fg = FB_COLOR_WHITE;
            g_buffer[row][col].bg = FB_COLOR_BLACK;
        }
    }
    
    g_cursor_col = 0;
    g_cursor_row = 0;
    g_view_start = 0;
    g_fg_color = FB_COLOR_WHITE;
    g_bg_color = FB_COLOR_BLACK;
    g_initialized = true;
    
    /* Clear screen with dark blue background */
    fb_console_clear(FB_COLOR_BLUE);
    
    /* Draw a test pattern to verify framebuffer works */
    /* White border at top */
    for (uint32_t x = 0; x < g_fb_width && x < 640; x++) {
        for (uint32_t y = 0; y < 2; y++) {
            fb_put_pixel(x, y, FB_COLOR_WHITE);
        }
    }
    
    return 0;
}

bool fb_console_available(void) {
    return g_initialized;
}

void fb_console_clear(uint32_t bg_color) {
    if (!g_initialized) return;
    
    /* Clear framebuffer */
    for (uint32_t y = 0; y < g_fb_height; y++) {
        for (uint32_t x = 0; x < g_fb_width; x++) {
            fb_put_pixel(x, y, bg_color);
        }
    }
    
    /* Clear buffer */
    for (int row = 0; row < FB_CONSOLE_BUFFER_LINES; row++) {
        for (int col = 0; col < FB_CONSOLE_COLS; col++) {
            g_buffer[row][col].c = ' ';
            g_buffer[row][col].fg = g_fg_color;
            g_buffer[row][col].bg = bg_color;
        }
    }
    
    g_cursor_col = 0;
    g_cursor_row = 0;
    g_view_start = 0;
    g_bg_color = bg_color;
}

void fb_console_set_color(uint32_t fg, uint32_t bg) {
    g_fg_color = fg;
    g_bg_color = bg;
}

void fb_console_set_vga_color(uint8_t fg, uint8_t bg) {
    if (fg < 16) g_fg_color = vga_to_fb_color[fg];
    if (bg < 16) g_bg_color = vga_to_fb_color[bg];
}

void fb_console_putc(char c) {
    if (!g_initialized) return;
    
    int buffer_row = g_view_start + g_cursor_row;
    
    if (c == '\n') {
        g_cursor_col = 0;
        g_cursor_row++;
    } else if (c == '\r') {
        g_cursor_col = 0;
    } else if (c == '\t') {
        g_cursor_col = (g_cursor_col + 8) & ~7;
    } else if (c == '\b') {
        if (g_cursor_col > 0) {
            g_cursor_col--;
            g_buffer[buffer_row][g_cursor_col].c = ' ';
            fb_draw_char(g_cursor_col, g_cursor_row, ' ', g_fg_color, g_bg_color);
        }
    } else {
        /* Regular character */
        g_buffer[buffer_row][g_cursor_col].c = c;
        g_buffer[buffer_row][g_cursor_col].fg = g_fg_color;
        g_buffer[buffer_row][g_cursor_col].bg = g_bg_color;
        
        fb_draw_char(g_cursor_col, g_cursor_row, c, g_fg_color, g_bg_color);
        g_cursor_col++;
    }
    
    /* Handle line wrap */
    if (g_cursor_col >= FB_CONSOLE_COLS) {
        g_cursor_col = 0;
        g_cursor_row++;
    }
    
    /* Handle scroll */
    if (g_cursor_row >= FB_CONSOLE_ROWS) {
        g_cursor_row = FB_CONSOLE_ROWS - 1;
        g_view_start++;
        
        if (g_view_start + FB_CONSOLE_ROWS > FB_CONSOLE_BUFFER_LINES) {
            fb_scroll_buffer();
            g_view_start = FB_CONSOLE_BUFFER_LINES - FB_CONSOLE_ROWS;
        }
        
        fb_console_refresh();
    }
}

void fb_console_puts(const char *str) {
    if (!str) return;
    while (*str) {
        fb_console_putc(*str++);
    }
}

void fb_console_put_hex(uint64_t value) {
    const char hex_chars[] = "0123456789ABCDEF";
    fb_console_puts("0x");
    
    /* Find first non-zero nibble */
    int started = 0;
    for (int i = 15; i >= 0; i--) {
        int nibble = (value >> (i * 4)) & 0xF;
        if (nibble != 0 || started || i == 0) {
            fb_console_putc(hex_chars[nibble]);
            started = 1;
        }
    }
}

void fb_console_put_dec(uint64_t value) {
    if (value == 0) {
        fb_console_putc('0');
        return;
    }
    
    char buf[21];
    int i = 0;
    
    while (value > 0) {
        buf[i++] = '0' + (value % 10);
        value /= 10;
    }
    
    while (i > 0) {
        fb_console_putc(buf[--i]);
    }
}

void fb_console_refresh(void) {
    if (!g_initialized) return;
    
    for (int row = 0; row < FB_CONSOLE_ROWS; row++) {
        int buffer_row = g_view_start + row;
        for (int col = 0; col < FB_CONSOLE_COLS; col++) {
            fb_char_t *ch = &g_buffer[buffer_row][col];
            fb_draw_char(col, row, ch->c, ch->fg, ch->bg);
        }
    }
}

void fb_console_scroll_up(void) {
    if (g_view_start > 0) {
        g_view_start--;
        fb_console_refresh();
    }
}

void fb_console_scroll_down(void) {
    if (g_view_start + FB_CONSOLE_ROWS < FB_CONSOLE_BUFFER_LINES) {
        g_view_start++;
        fb_console_refresh();
    }
}

void fb_console_get_cursor(int *col, int *row) {
    if (col) *col = g_cursor_col;
    if (row) *row = g_cursor_row;
}

void fb_console_set_cursor(int col, int row) {
    if (col >= 0 && col < FB_CONSOLE_COLS) g_cursor_col = col;
    if (row >= 0 && row < FB_CONSOLE_ROWS) g_cursor_row = row;
}
